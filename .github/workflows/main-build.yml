# building Flutter application by Actions

name: Build

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ prototype ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
jobs:
  darwin:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        channel: dev
    - run: flutter config --enable-macos-desktop
    - run: |
        cp lib/mapbox_api_key.dart.example lib/mapbox_api_key.dart
        sed -i '' "s/WHATEVER/${{secrets.MAPBOX_API_KEY}}/g" lib/mapbox_api_key.dart
    - run: |
        flutter pub get
        flutter build ios --release --no-codesign
        flutter build macos --release | true # fixing issues with missing credentials
    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: macos-artifacts
        path: build/darwin
  linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        channel: dev
    - run: |
        sudo apt update
        sudo apt install clang cmake ninja-build pkg-config libgtk-3-dev libblkid-dev liblzma-dev
    - run: |
        flutter config --enable-web
        flutter config --enable-linux-desktop
    - run: |
        cp lib/mapbox_api_key.dart.example lib/mapbox_api_key.dart
        sed -i "s/WHATEVER/${{secrets.MAPBOX_API_KEY}}/g" lib/mapbox_api_key.dart
    - run: |
        flutter pub get
        flutter build web
        sed -i "s/base\ href=\"/base\ href=\"\/memorypath_app/g" build/web/index.html
        flutter build apk --debug # waiting for shared credentials on GitHub
        flutter build linux
    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: linux-artifacts
        path: build/linux/x64/release/bundle
    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: android-artifacts
        path: build/app/outputs/flutter-apk/app-release.apk
    - name: Deploy ðŸš€
      uses: JamesIves/github-pages-deploy-action@4.0.0
      with:
        branch: gh-pages # The branch the action should deploy to.
        folder: build/web # The folder the action should deploy.
  windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        channel: dev
    - run: flutter config --enable-windows-desktop
    - run: |
        cp lib/mapbox_api_key.dart.example lib/mapbox_api_key.dart
        powershell -Command "(gc lib/mapbox_api_key.dart) -replace 'WHATEVER', '%{{secrets.MAPBOX_API_KEY}}%' | Out-File -encoding UTF8 lib/mapbox_api_key.dart"
    - run: |
        flutter pub get
        flutter build windows
    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: windows-artifacts
        path: build/windows/runner/Release
